<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>テキーラカウンターRealtime</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

   <style>
        /* 全体の設定：ダークモードで高級感と怪しさを出す */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Helvetica Neue", "Hiragino Kaku Gothic ProN", "Yu Gothic", sans-serif;
            background: linear-gradient(135deg, #1a1a1a 0%, #000000 100%);
            color: #ecf0f1;
            text-align: center; 
            margin: 0; 
            padding-bottom: 100px; 
            min-height: 100vh;
        }

        /* ヘッダー：グラデーションで目立たせる */
        .header { 
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(10px); /* すりガラス効果 */
            padding: 25px 20px; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            border-bottom: 1px solid #333;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
        }

        .total-info { 
            display: flex; 
            justify-content: center; 
            align-items: baseline; 
            gap: 10px; 
            margin-bottom: 10px;
        }

        /* 残り杯数の数字：ネオンっぽく光らせる */
        .remain-count { 
            font-size: 4.5rem; 
            font-weight: 900; 
            color: #ff0055; 
            text-shadow: 0 0 20px rgba(255, 0, 85, 0.6);
            line-height: 1;
        }

        .target-input-area { 
            font-size: 0.9rem; 
            color: #888; 
            background: #222;
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
        }

        input[type="number"] { 
            background: transparent; 
            color: #fff; 
            border: none; 
            border-bottom: 1px solid #555; 
            font-size: 1rem; 
            text-align: center; 
            width: 50px; 
            font-weight: bold;
        }

        /* メンバーリスト周り */
        .members { padding: 20px; max-width: 600px; margin: 0 auto; }
        
        .card { 
            background: linear-gradient(145deg, #2b2b2b, #1e1e1e);
            margin-bottom: 15px; 
            padding: 15px 20px; 
            border-radius: 16px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            box-shadow: 5px 5px 10px #0b0b0b, -5px -5px 10px #333; /* 凹凸感 */
            transition: transform 0.2s;
        }

        .card:active { transform: scale(0.98); } /* 押したときに少し凹む */

        .card-left { text-align: left; }
        .member-name { font-size: 1.2rem; font-weight: bold; display: block; margin-bottom: 4px; color: #fff; }
        .member-count { font-size: 0.85rem; color: #f1c40f; letter-spacing: 1px; }

        /* プラスボタン：グラデーションで目立たせる */
        .btn-add { 
            background: linear-gradient(135deg, #00b894, #00cec9);
            border: none; 
            color: white; 
            width: 55px; 
            height: 55px; 
            border-radius: 50%; 
            font-size: 1.8rem; 
            cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
            transition: all 0.1s;
        }
        .btn-add:active { transform: scale(0.9); box-shadow: 0 2px 5px rgba(0, 184, 148, 0.4); }

        /* 下部の操作ボタンエリア */
        .controls { 
            margin: 30px 20px; 
            display: flex; 
            justify-content: center; 
            gap: 15px; 
            flex-wrap: wrap;
        }

        .btn-ctrl { 
            padding: 12px 24px; 
            border-radius: 30px; 
            border: none; 
            font-weight: bold; 
            cursor: pointer; 
            font-size: 0.9rem;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: transform 0.1s;
        }
        .btn-ctrl:active { transform: translateY(2px); }

        .btn-green { background: #06c755; color: white; } /* LINEカラー */
        .btn-gray { background: #34495e; color: white; }
        .btn-red { background: linear-gradient(to right, #c0392b, #e74c3c); color: white; margin-top: 20px; width: 80%; }

        /* 達成時の演出：ゴールドに輝く */
        .celebration { 
            background: linear-gradient(to bottom, #d4af37, #f1c40f) !important; 
            border-bottom: none;
        }
        .celebration .remain-count { color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .celebration .target-input-area { background: rgba(0,0,0,0.2); color: #fff; }
    </style>
</head>
<body>

    <div class="header" id="header-bg">
        <div class="total-info">
            <span>残り</span>
            <span class="remain-count" id="remain-display">--</span>
            <span>杯</span>
        </div>
        <div class="target-input-area">
            目標設定: <input type="number" id="target-input" value="30" onchange="updateTarget()"> 杯
        </div>
    </div>

    <div class="members" id="members-container">
        <p>読み込み中...</p>
    </div>

    <div class="controls">
        <button class="btn-ctrl btn-green" onclick="addMyself()">LINEで参加</button>
        <button class="btn-ctrl btn-gray" onclick="addGuest()">ゲスト追加</button>
    </div>
    
    <div style="margin-top: 30px;">
        <button class="btn-ctrl btn-red" onclick="resetAll()">リセット</button>
    </div>

    <script>
        // ▼▼ 設定エリア（ここを書き換える！） ▼▼
        const LIFF_ID = "2008790629-0ju0alVp"; 
        
        // さっきコピーした中身をここに貼り付けてください↓↓
        const firebaseConfig = {apiKey: "AIzaSyA4RAxIsuLPd856yYcjkg2QlMRoOOnbpu4",
  authDomain: "tequilacounter.firebaseapp.com",
  databaseURL: "https://tequilacounter-default-rtdb.firebaseio.com",
  projectId: "tequilacounter",
  storageBucket: "tequilacounter.firebasestorage.app",
  messagingSenderId: "658800119982",
  appId: "1:658800119982:web:b9f4417a5474a3c2529d3f"
        };
        // ▲▲ 設定エリア終了 ▲▲

        // Firebase初期化
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        
        let appData = { target: 30, members: [] };

        async function main() {
            // データベースの変更を監視（リアルタイム同期の肝）
            db.ref('partyData').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appData = data;
                    if (!appData.members) appData.members = []; // 空の場合の対策
                    render();
                } else {
                    // データが無いときは初期化
                    saveData();
                }
            });

            await liff.init({ liffId: LIFF_ID });
            if (!liff.isLoggedIn()) {
                liff.login();
            }
        }

        function render() {
            document.getElementById('target-input').value = appData.target;
            const container = document.getElementById('members-container');
            container.innerHTML = '';

            let totalDrunk = 0;

            appData.members.forEach((member, index) => {
                totalDrunk += member.count;
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-left">
                        <span class="member-name" onclick="renameMember(${index})">${member.name} ✎</span>
                        <span class="member-count">飲んだ量: ${member.count}杯</span>
                    </div>
                    <button class="btn-add" onclick="drink(${index})">＋</button>
                `;
                container.appendChild(div);
            });

            const remain = appData.target - totalDrunk;
            const header = document.getElementById('header-bg');
            const remainDisplay = document.getElementById('remain-display');
            
            remainDisplay.innerText = remain > 0 ? remain : 0;
            
            if (remain <= 0) {
                header.classList.add('celebration');
                remainDisplay.innerText = "達成!!";
            } else {
                header.classList.remove('celebration');
            }
        }

        // ▼ アクション（DBに保存しにいく）

        function saveData() {
            // 変更内容をFirebaseに送信
            db.ref('partyData').set(appData);
        }

        function drink(index) {
            appData.members[index].count++;
            saveData(); // ここで全員に同期される
        }

        async function addMyself() {
            try {
                const profile = await liff.getProfile();
                addMemberToList(profile.displayName);
            } catch (err) {
                alert("LINE情報の取得に失敗しました");
            }
        }

        function addGuest() {
            addMemberToList(`メンバー ${appData.members.length + 1}`);
        }

        function addMemberToList(name) {
            const exists = appData.members.some(m => m.name === name);
            if (!exists) {
                appData.members.push({ name: name, count: 0 });
                saveData();
            }
        }

        function renameMember(index) {
            const newName = prompt("新しい名前:", appData.members[index].name);
            if (newName) {
                appData.members[index].name = newName;
                saveData();
            }
        }

        function updateTarget() {
            const val = document.getElementById('target-input').value;
            appData.target = parseInt(val);
            saveData();
        }

        function resetAll() {
            if(confirm("全員のデータをリセットしますか？")) {
                appData.members = [];
                appData.target = 30;
                saveData();
            }
        }

        main();
    </script>
</body>
</html>