<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ãƒ†ã‚­ãƒ¼ãƒ©ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼History</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        /* ãƒ‡ã‚¶ã‚¤ãƒ³è¨­å®š */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            
            /* â–¼â–¼ èƒŒæ™¯è¨­å®šï¼šãƒ¡ã‚­ã‚·ã‚«ãƒ³ãƒ»ã‚µãƒ©ãƒšé¢¨ã‚¹ãƒˆãƒ©ã‚¤ãƒ— â–¼â–¼ */
            background-color: #111;
            background-image: 
                /* æ–‡å­—ã‚’èª­ã¿ã‚„ã™ãã™ã‚‹ãŸã‚ã®é»’ã„ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ */
                linear-gradient(rgba(0, 0, 0, 0.85), rgba(0, 0, 0, 0.95)),
                /* ã‚«ãƒ©ãƒ•ãƒ«ãªã‚¹ãƒˆãƒ©ã‚¤ãƒ—æŸ„ */
                repeating-linear-gradient(
                    135deg,
                    #c0392b, #c0392b 20px, /* èµ¤ */
                    #f1c40f 20px, #f1c40f 40px, /* é»„ */
                    #27ae60 40px, #27ae60 60px, /* ç·‘ */
                    #2980b9 60px, #2980b9 80px, /* é’ */
                    #8e44ad 80px, #8e44ad 100px /* ç´« */
                );
            background-attachment: fixed; /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã—ã¦ã‚‚èƒŒæ™¯ã‚’å›ºå®š */
            background-size: cover;
            
            color: #ecf0f1; text-align: center; margin: 0; padding-bottom: 120px; min-height: 100vh;
        }

        .header { 
            background: rgba(20, 20, 20, 0.9); backdrop-filter: blur(8px);
            padding: 15px 20px 25px 20px; position: sticky; top: 0; z-index: 100; 
            border-bottom: 1px solid #444; box-shadow: 0 5px 20px rgba(0,0,0,0.6);
        }
        
        /* ãƒ˜ãƒƒãƒ€ãƒ¼è£…é£¾ */
        .total-info { display: flex; justify-content: center; align-items: center; gap: 5px; margin-bottom: 10px; }
        
        .remain-count { font-size: 4.5rem; font-weight: 900; color: #ff0055; text-shadow: 0 0 20px rgba(255, 0, 85, 0.6); line-height: 1; vertical-align: bottom; }
        .target-input-area { font-size: 0.9rem; color: #ccc; background: rgba(255,255,255,0.1); display: inline-block; padding: 5px 15px; border-radius: 20px; backdrop-filter: blur(5px); }
        input[type="number"] { background: transparent; color: #fff; border: none; border-bottom: 1px solid #aaa; font-size: 1rem; text-align: center; width: 50px; font-weight: bold; }
        
        .members { padding: 20px; max-width: 600px; margin: 0 auto; }
        .card { 
            background: linear-gradient(145deg, rgba(43,43,43,0.9), rgba(30,30,30,0.9));
            margin-bottom: 15px; padding: 15px 20px; border-radius: 16px; 
            display: flex; justify-content: space-between; align-items: center; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.05);
        }
        .card-left { text-align: left; }
        .member-name { font-size: 1.2rem; font-weight: bold; display: block; margin-bottom: 4px; color: #fff; }
        .member-count { font-size: 0.85rem; color: #f1c40f; letter-spacing: 1px; }
        
        /* ãƒœã‚¿ãƒ³è£…é£¾ï¼šãƒ†ã‚­ãƒ¼ãƒ©ã‚°ãƒ©ã‚¹ */
        .btn-add { 
            background: linear-gradient(135deg, #00b894, #00cec9); border: none; color: white; 
            width: 65px; height: 65px; border-radius: 50%; cursor: pointer; 
            box-shadow: 0 4px 15px rgba(0, 184, 148, 0.4);
            display: flex; justify-content: center; align-items: center; padding-bottom: 5px; 
        }
        .btn-add:active { transform: scale(0.9); }

        /* ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ã‚¨ãƒªã‚¢ */
        .controls { margin: 15px 20px; display: flex; justify-content: center; gap: 10px; flex-wrap: wrap; }
        .btn-ctrl { padding: 12px 20px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; font-size: 0.9rem; box-shadow: 0 4px 10px rgba(0,0,0,0.3); flex: 1; min-width: 100px; }
        
        .btn-blue { background: #3498db; color: white; width: 100%; margin-bottom: 10px; flex: none; }
        .btn-green { background: #06c755; color: white; }
        .btn-gray { background: #34495e; color: white; }
        
        .btn-orange { background: linear-gradient(to right, #e67e22, #f39c12); color: white; }
        .btn-red { background: linear-gradient(to right, #c0392b, #e74c3c); color: white; }

        .celebration { background: linear-gradient(to bottom, #d4af37, #f1c40f) !important; }
        .celebration .remain-count { color: #fff; text-shadow: 0 2px 5px rgba(0,0,0,0.5); }
        .celebration span { color: #fff !important; }

        /* å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 200; overflow-y: auto; backdrop-filter: blur(3px);
        }
        .modal-content {
            background: #222; margin: 10% auto; padding: 20px; width: 85%; max-width: 500px;
            border-radius: 15px; text-align: left; position: relative; border: 1px solid #444;
        }
        .close-btn { position: absolute; top: 10px; right: 15px; font-size: 2rem; color: #aaa; cursor: pointer; }
        .history-title { text-align: center; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 15px; color: #3498db; }
        .history-block { margin-bottom: 20px; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .h-name { font-size: 1.1rem; font-weight: bold; color: #f1c40f; margin-bottom: 5px; }
        .h-record { font-size: 0.9rem; color: #ccc; margin-left: 10px; display: flex; justify-content: space-between; margin-bottom: 3px; }
        .no-data { text-align: center; color: #888; padding: 20px; }
    </style>
</head>
<body>

    <div class="header" id="header-bg">
        <div class="total-info">
            <span style="font-size: 2.5rem;">ğŸ¥ƒ</span>
            <div style="display: flex; flex-direction: column; padding: 0 5px;">
                <span style="font-size: 0.8rem; color: #aaa; letter-spacing: 2px; margin-bottom: -5px;">REMAINING</span>
                <div>
                    <span class="remain-count" id="remain-display">--</span>
                    <span style="font-size: 1.2rem; font-weight: bold;">SHOTS</span>
                </div>
            </div>
            <span style="font-size: 2.5rem;">ğŸ‹</span>
        </div>

        <div class="target-input-area">
            ç›®æ¨™: <input type="number" id="target-input" value="30" onchange="updateTarget()"> æ¯
        </div>
    </div>

    <div class="members" id="members-container">
        <p>Loading...</p>
    </div>

    <div class="controls">
        <button class="btn-ctrl btn-blue" onclick="openHistory()">ğŸ“œ éå»ã®å±¥æ­´</button>
    </div>
    <div class="controls">
        <button class="btn-ctrl btn-green" onclick="addMyself()">LINEã§å‚åŠ </button>
        <button class="btn-ctrl btn-gray" onclick="addGuest()">ã‚²ã‚¹ãƒˆè¿½åŠ </button>
    </div>
    
    <div class="controls" style="margin-top: 30px; border-top: 1px solid #555; padding-top: 20px;">
        <button class="btn-ctrl btn-orange" onclick="saveHistory()">ğŸ’¾ è¨˜éŒ²ä¿å­˜</button>
        <button class="btn-ctrl btn-red" onclick="resetAll()">ğŸ—‘ï¸ ãƒªã‚»ãƒƒãƒˆ</button>
    </div>

    <div id="historyModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" onclick="closeHistory()">&times;</span>
            <h2 class="history-title">ãƒ¡ãƒ³ãƒãƒ¼åˆ¥ é£²é…’è¨˜éŒ²</h2>
            <div id="history-list"></div>
        </div>
    </div>

    <script>
        // â–¼â–¼ è¨­å®šã‚¨ãƒªã‚¢ â–¼â–¼
        
        // â˜…ã”æŒ‡å®šã®LIFF IDã‚’è¨­å®šã—ã¾ã—ãŸâ˜…
        const LIFF_ID = "2008790629-0ju0alVp"; 
        
        // â˜…ã“ã“ã«å‰å›ã®Firebaseè¨­å®šã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„â˜…
        const firebaseConfig = {
            apiKey: "AIzaSy.....",
            authDomain: ".....",
            databaseURL: "https://.....",
            projectId: ".....",
            storageBucket: ".....",
            messagingSenderId: ".....",
            appId: "....."
        };
        // â–²â–² è¨­å®šã‚¨ãƒªã‚¢çµ‚äº† â–²â–²

        // FirebaseåˆæœŸåŒ–
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const db = firebase.database();
        
        let appData = { target: 30, members: [] };

        async function main() {
            db.ref('partyData').on('value', (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    appData = data;
                    if (!appData.members) appData.members = [];
                    render();
                } else {
                    saveData();
                }
            });

            // LIFFåˆæœŸåŒ–
            await liff.init({ liffId: LIFF_ID });
            // â€»æ³¨æ„: ãƒ­ãƒ¼ã‚«ãƒ«(file://)ã§é–‹ãã¨ã“ã“ã§ã‚¨ãƒ©ãƒ¼ã«ãªã‚Šã¾ã™ãŒæ­£å¸¸ã§ã™ã€‚
            if (liff.isLoggedIn()) {
               console.log("Logged in");
            }
        }

        function render() {
            document.getElementById('target-input').value = appData.target;
            const container = document.getElementById('members-container');
            container.innerHTML = '';

            let totalDrunk = 0;

            appData.members.forEach((member, index) => {
                totalDrunk += member.count;
                const div = document.createElement('div');
                div.className = 'card';
                // ãƒœã‚¿ãƒ³ã‚’çµµæ–‡å­—ã«å¤‰æ›´
                div.innerHTML = `
                    <div class="card-left">
                        <span class="member-name" onclick="renameMember(${index})">${member.name} âœ</span>
                        <span class="member-count">æœ¬æ—¥: ${member.count}æ¯</span>
                    </div>
                    <button class="btn-add" onclick="drink(${index})" style="font-size: 2.2rem;">ğŸ¥ƒ</button>
                `;
                container.appendChild(div);
            });

            const remain = appData.target - totalDrunk;
            const header = document.getElementById('header-bg');
            const remainDisplay = document.getElementById('remain-display');
            
            remainDisplay.innerText = remain > 0 ? remain : 0;
            
            if (remain <= 0) {
                header.classList.add('celebration');
                remainDisplay.innerText = "é”æˆ!!";
            } else {
                header.classList.remove('celebration');
            }
        }

        function saveData() { db.ref('partyData').set(appData); }

        function drink(index) {
            appData.members[index].count++;
            saveData();
        }

        async function addMyself() {
            try {
                // LIFFãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
                if (!liff.isLoggedIn()) {
                    liff.login();
                    return;
                }
                const profile = await liff.getProfile();
                addMemberToList(profile.displayName);
            } catch (err) { 
                console.error(err);
                alert("LINEæƒ…å ±ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚\n(ã‚µãƒ¼ãƒãƒ¼ã«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ã¦httpsã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ã„ã¾ã™ã‹ï¼Ÿ)"); 
            }
        }

        function addGuest() { addMemberToList(`ãƒ¡ãƒ³ãƒãƒ¼ ${appData.members.length + 1}`); }

        function addMemberToList(name) {
            const exists = appData.members.some(m => m.name === name);
            if (!exists) {
                appData.members.push({ name: name, count: 0 });
                saveData();
            }
        }

        function renameMember(index) {
            const newName = prompt("æ–°ã—ã„åå‰:", appData.members[index].name);
            if (newName) {
                appData.members[index].name = newName;
                saveData();
            }
        }

        function updateTarget() {
            appData.target = parseInt(document.getElementById('target-input').value);
            saveData();
        }

        function saveHistory() {
            if(!appData.members.length) {
                alert("è¨˜éŒ²ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“");
                return;
            }
            if(!confirm("ç¾åœ¨ã®ã‚«ã‚¦ãƒ³ãƒˆæ•°ã‚’å±¥æ­´ã«ä¿å­˜ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆç”»é¢ã®ã‚«ã‚¦ãƒ³ãƒˆã¯ãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã›ã‚“ï¼‰")) return;

            const today = new Date().toLocaleDateString('ja-JP');
            const historyEntry = {
                date: today,
                members: appData.members
            };

            db.ref('history').push(historyEntry).then(() => {
                alert("âœ… è¨˜éŒ²ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
            });
        }

        function resetAll() {
            if(confirm("âš ï¸ æ³¨æ„\nã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’å…¨ã¦0ã«æˆ»ã—ã€ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) {
                appData.members = [];
                appData.target = 30;
                saveData();
            }
        }

        function openHistory() {
            document.getElementById('historyModal').style.display = 'block';
            db.ref('history').once('value').then((snapshot) => {
                const histories = snapshot.val();
                const listDiv = document.getElementById('history-list');
                listDiv.innerHTML = '';

                if (!histories) {
                    listDiv.innerHTML = '<p class="no-data">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
                    return;
                }

                let memberStats = {}; 
                Object.values(histories).forEach(session => {
                    if(session.members) {
                        session.members.forEach(m => {
                            if(!memberStats[m.name]) memberStats[m.name] = [];
                            memberStats[m.name].push({ date: session.date, count: m.count });
                        });
                    }
                });

                let hasData = false;
                for (let name in memberStats) {
                    hasData = true;
                    let html = `<div class="history-block"><div class="h-name">${name}</div>`;
                    memberStats[name].forEach(record => {
                        html += `<div class="h-record"><span>${record.date}</span><span>${record.count}æ¯</span></div>`;
                    });
                    html += `</div>`;
                    listDiv.innerHTML += html;
                }
                if(!hasData) listDiv.innerHTML = '<p class="no-data">ãƒ‡ãƒ¼ã‚¿ãªã—</p>';
            });
        }

        function closeHistory() {
            document.getElementById('historyModal').style.display = 'none';
        }

        main();
    </script>
</body>
</html>